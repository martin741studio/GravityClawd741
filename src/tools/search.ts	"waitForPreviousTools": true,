import { Tool } from './registry.js';
import { config } from '../config.js';

/**
 * Tool to search the web using Serper.dev API.
 */
export const searchWebTool: Tool = {
    name: 'search_web',
    description: 'Searches the web for real-time information, news, or specific queries. Returns a list of results with titles, snippets, and links.',
    parameters: {
        type: 'object',
        properties: {
            query: {
                type: 'string',
                description: 'The search query to look up.'
            }
        },
        required: ['query']
    },
    execute: async (args: { query: string }) => {
        const apiKey = process.env.SERPER_API_KEY;
        if (!apiKey) {
            return 'Error: SERPER_API_KEY is not set in environment variables. Please add it to your .env file.';
        }

        try {
            console.log(`[WebTool] Searching web for: ${args.query}`);
            const response = await fetch('https://google.serper.dev/search', {
                method: 'POST',
                headers: {
                    'X-API-KEY': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    q: args.query,
                    num: 5
                })
            });

            if (!response.ok) {
                return `Error: Search API failed (Status ${response.status}: ${response.statusText})`;
            }

            const data = await response.json();
            
            if (!data.organic || data.organic.length === 0) {
                return 'No organic search results found for this query.';
            }

            const results = data.organic.map((res: any, index: number) => {
                return `${index + 1}. **${res.title}**\n   Link: ${res.link}\n   Snippet: ${res.snippet}`;
            });

            return `Search results for "${args.query}":\n\n${results.join('\n\n')}\n\n[Tip: Use 'read_url' to dive deeper into any of these links.]`;
        } catch (error: any) {
            console.error(`[WebTool] Search error:`, error);
            return `Error performing search: ${error.message}`;
        }
    }
};
